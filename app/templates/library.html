{% extends "base.html" %}

{% block title %}My Library - WordFlow{% endblock %}

{% block content %}
<div class="library-container">
    <div class="library-header">
        <h1>My Library</h1>
        <p class="subtitle">Your collection of {{ documents|length }} books</p>
    </div>
    
    <!-- Stats Bar -->
    <div class="library-stats">
        <div class="stat-card">
            <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                </svg>
            </div>
            <div class="stat-info">
                <span class="stat-number">{{ documents|length }}</span>
                <span class="stat-label">Total Books</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
            </div>
            <div class="stat-info">
                <span class="stat-number">{{ documents|sum(attribute='document.word_count') }}</span>
                <span class="stat-label">Total Words</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                </svg>
            </div>
            <div class="stat-info">
                <span class="stat-number">{{ documents|selectattr('percentage', 'equalto', 100)|list|length }}</span>
                <span class="stat-label">Completed</span>
            </div>
        </div>
    </div>
    
    <!-- Books Grid -->
    {% if documents %}
    <div class="books-grid">
        {% for item in documents %}
        <div class="book-card" data-id="{{ item.document.id }}">
            <div class="book-cover">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
            </div>
            <div class="book-info">
                <h3 class="book-title" title="{{ item.document.original_name }}">
                    {{ item.document.original_name }}
                </h3>
                <p class="book-meta">{{ item.document.word_count }} words</p>
                <p class="book-date">Added {{ item.document.created_at.strftime('%b %d, %Y') }}</p>
                <div class="book-progress">
                    <div class="progress-bar-mini">
                        <div class="progress-fill-mini" style="width: {{ item.percentage }}%"></div>
                    </div>
                    <span class="progress-label">{{ item.percentage }}%</span>
                </div>
            </div>
            <div class="book-actions">
                <a href="{{ url_for('reader.read', doc_id=item.document.id) }}" class="btn btn-primary btn-small">
                    {% if item.progress > 0 %}Continue{% else %}Start{% endif %}
                </a>
                <button class="btn btn-danger btn-small delete-btn" data-id="{{ item.document.id }}">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-library">
        <div class="empty-icon">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
            </svg>
        </div>
        <h2>Your library is empty</h2>
        <p>Upload your first PDF to start building your reading collection</p>
        <a href="{{ url_for('dashboard.dashboard') }}" class="btn btn-primary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Upload PDF
        </a>
    </div>
    {% endif %}
</div>

</div>

<!-- Delete Confirmation Modal -->
<div class="modal-backdrop" id="deleteModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Delete Book</h3>
            <button class="modal-close" id="closeModal">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to delete <strong id="deleteBookTitle">this book</strong>?</p>
            <p class="text-sm" style="margin-top: 0.5rem; color: var(--text-muted);">This will permanently remove the document and all reading progress. You cannot undo this action.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="cancelDelete">Cancel</button>
            <button class="btn btn-danger" id="confirmDelete">Delete</button>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    const deleteModal = document.getElementById('deleteModal');
    const deleteBookTitle = document.getElementById('deleteBookTitle');
    const confirmDeleteBtn = document.getElementById('confirmDelete');
    const cancelDeleteBtn = document.getElementById('cancelDelete');
    const closeModalBtn = document.getElementById('closeModal');
    let deleteId = null;
    let deleteCard = null;

    function openModal(id, title, card) {
        deleteId = id;
        deleteCard = card;
        deleteBookTitle.textContent = title;
        deleteModal.style.display = 'flex';
        // Force reflow for transition
        deleteModal.offsetHeight;
        deleteModal.classList.add('active');
    }

    function closeModal() {
        deleteModal.classList.remove('active');
        setTimeout(() => {
            deleteModal.style.display = 'none';
            deleteId = null;
            deleteCard = null;
        }, 300);
    }

    // Modal Events
    closeModalBtn.addEventListener('click', closeModal);
    cancelDeleteBtn.addEventListener('click', closeModal);
    deleteModal.addEventListener('click', (e) => {
        if (e.target === deleteModal) closeModal();
    });

    // Delete Buttons
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const card = this.closest('.book-card');
            const title = card.querySelector('.book-title').textContent.trim();
            const id = this.dataset.id;
            openModal(id, title, card);
        });
    });

    // Confirm Delete Action
    confirmDeleteBtn.addEventListener('click', async function() {
        if (!deleteId) return;
        
        // Show loading state
        const originalText = this.textContent;
        this.textContent = 'Deleting...';
        this.disabled = true;

        try {
            const response = await fetch(`/document/${deleteId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                closeModal();
                // Remove card animation
                if (deleteCard) {
                    deleteCard.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    deleteCard.style.opacity = '0';
                    deleteCard.style.transform = 'scale(0.9)';
                    
                    setTimeout(() => {
                        deleteCard.remove();
                        // Reload if empty
                        if (document.querySelectorAll('.book-card').length === 0) {
                            location.reload();
                        }
                        // Update total count
                        const countEl = document.querySelector('.stat-number');
                        if (countEl) countEl.textContent = parseInt(countEl.textContent) - 1;
                    }, 300);
                }
            } else {
                alert('Failed to delete document.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while deleting.');
        } finally {
            this.textContent = originalText;
            this.disabled = false;
        }
    });
</script>
{% endblock %}
{% endblock %}
